<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Transcription Studio</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/dist/tabler-icons.min.css">
  <link rel="stylesheet" href="/src/styles.css">
  <script>
    // Apply saved layout preferences before render to prevent flash
    (function() {
      var sidebarWidth = localStorage.getItem('sidebar-width');
      if (sidebarWidth) {
        document.documentElement.style.setProperty('--sidebar-width', sidebarWidth + 'px');
      }
      var workspaceTop = localStorage.getItem('workspace-top-percent');
      if (workspaceTop) {
        var style = document.createElement('style');
        style.textContent = '#raw-chunks-panel { flex: 0 0 ' + workspaceTop + '% !important; }';
        document.head.appendChild(style);
      }
    })();
  </script>
</head>
<body>
  <!-- SVG Sprite Sheet (hidden) -->
  <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
    <symbol id="icon-loader" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 3a9 9 0 1 0 9 9" />
    </symbol>
  </svg>

  <div id="app">
    <!-- Top Bar -->
    <header id="topbar">
      <div class="topbar-left">
        <h1>Transcription Studio</h1>
      </div>
      <div class="topbar-center" x-data="recordingControls()" x-cloak>
        <div class="button-group">
          <button id="record-btn" class="btn"
                  :class="{ 'recording': isRecording }"
                  :disabled="!modelLoaded"
                  @click="toggleRecording()">
            <i x-show="!isRecording" class="ti ti-microphone"></i>
            <i x-show="isRecording" class="ti ti-player-stop"></i>
            <span x-text="isRecording ? 'Stop' : 'Record'"></span>
          </button>
          <button id="upload-btn" class="btn secondary"
                  :disabled="!modelLoaded || isRecording"
                  @click="uploadAudio()"><i class="ti ti-upload"></i> Upload</button>
          <input type="file" id="upload-file-input" accept="audio/*" class="hidden">
          <button id="clear-btn" class="btn secondary"
                  :disabled="!modelLoaded"
                  @click="clearTranscript()"><i class="ti ti-eraser"></i> Clear</button>
        </div>
        <div id="audio-visualizer" :class="{ 'active': isRecording }"></div>
        <div id="recording-status"></div>
      </div>
      <div class="topbar-right">
        <div class="mic-config">
          <label for="mic-select">Mic:</label>
          <select id="mic-select">
            <option value="">Default</option>
          </select>
        </div>
        <div class="speaker-config">
          <label for="num-speakers">Speakers:</label>
          <select id="num-speakers">
            <option value="1">1</option>
            <option value="2" selected>2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
          </select>
        </div>
      </div>
    </header>

    <!-- Main Content Grid -->
    <main id="main-content">
      <!-- Transcript Workspace (left) -->
      <section id="transcript-section" class="workspace">
        <!-- Raw Chunks Panel (top 1/3) -->
        <div id="raw-chunks-panel">
          <div class="panel-header-inline">
            <h3>Raw Whisper Output</h3>
            <span class="panel-subtitle">Word-by-word transcription before processing</span>
            <button id="export-raw-btn" class="btn secondary small" disabled><i class="ti ti-download"></i> Export</button>
          </div>
          <div id="raw-chunks-container">
            <p class="placeholder">Raw chunk data will appear here...</p>
          </div>
        </div>

        <!-- Divider -->
        <div class="workspace-divider"></div>

        <!-- Processed Transcript (bottom 2/3) -->
        <div id="processed-panel">
          <div class="panel-header-inline">
            <h3>Processed Transcript</h3>
            <span class="panel-subtitle">Grouped into phrases with speaker assignment</span>
            <!-- Feature 7: Comparison mode toggle -->
            <div x-data="comparisonMode" class="comparison-mode-controls">
              <button class="comparison-toggle" :class="{ 'active': enabled }" @click="toggle()" title="Compare segment embeddings">
                <i class="ti ti-arrows-left-right comparison-toggle-icon"></i>
                <span x-text="enabled ? 'Exit Compare' : 'Compare'"></span>
              </button>
            </div>
            <button id="copy-btn" class="btn secondary small" disabled><i class="ti ti-copy"></i> Copy</button>
            <button id="export-transcript-btn" class="btn secondary small" disabled><i class="ti ti-download"></i> Export</button>
          </div>
          <div id="transcript-container">
            <p class="placeholder">Transcript will appear here when you start recording...</p>
          </div>
        </div>
      </section>

      <!-- Sidebar resize divider -->
      <div class="sidebar-divider" id="sidebar-divider"></div>

      <!-- Debug Sidebar (right) -->
      <aside id="sidebar">
        <!-- Active Participants Panel -->
        <div class="sidebar-panel" id="panel-participants" x-data="panel('participants', true)" x-cloak>
          <div class="panel-header" @click="toggle()">
            <i class="ti ti-chevron-down panel-chevron" :class="{ 'rotated': !expanded }"></i>
            <h3>Active Participants</h3>
          </div>
          <div class="panel-content" :class="{ 'collapsed': !expanded }">
            <div id="participants-list"></div>
            <div id="participants-status" class="participants-status">Waiting for audio...</div>
          </div>
        </div>

        <!-- Phrase Stats Panel -->
        <div class="sidebar-panel" id="panel-phrase-stats" x-data="panel('phrase-stats', true)" x-cloak>
          <div class="panel-header" @click="toggle()">
            <i class="ti ti-chevron-down panel-chevron" :class="{ 'rotated': !expanded }"></i>
            <h3>Last Phrase</h3>
          </div>
          <div class="panel-content" :class="{ 'collapsed': !expanded }">
            <div id="phrase-stats" x-data="phraseStats()">
              <div class="phrase-text-preview" x-text="phrasePreview">No phrases yet</div>
              <div class="phrase-details">
                <div class="detail-row">
                  <span class="detail-label">Speaker:</span>
                  <span class="detail-value" x-text="phrase.speaker">-</span>
                </div>
                <div class="detail-row indent">
                  <span class="detail-label">Similarity:</span>
                  <span class="detail-value" x-text="phrase.similarity">-</span>
                </div>
                <div class="detail-row indent">
                  <span class="detail-label">Runner-up:</span>
                  <span class="detail-value" x-text="phrase.runnerUp">-</span>
                </div>
                <div class="detail-row indent">
                  <span class="detail-label">Margin:</span>
                  <span class="detail-value" :class="marginClass" x-text="phrase.margin">-</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Duration:</span>
                  <span class="detail-value" x-text="phrase.duration">-</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Type:</span>
                  <span class="detail-value" x-text="phrase.type">-</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Speaker Enrollment Panel -->
        <section id="enrollment-section" class="sidebar-panel" x-data="panel('enrollment', true)" x-cloak>
          <div class="panel-header" @click="toggle()">
            <i class="ti ti-chevron-down panel-chevron" :class="{ 'rotated': !expanded }"></i>
            <h3>Speaker Enrollment <span class="optional-badge">Optional</span></h3>
          </div>
          <div class="panel-content" :class="{ 'collapsed': !expanded }" x-data="enrollmentContent()">
            <!-- Intro state (before enrollment starts) -->
            <div x-show="state === 'intro'">
              <p>Record your voice to help identify you in conversations.</p>
              <div class="enroll-input-row">
                <label for="enroll-name">Name:</label>
                <input type="text" id="enroll-name" x-model="speakerName"
                       placeholder="e.g., Jake" maxlength="20">
                <button id="enroll-start-btn" class="btn primary small"
                        :disabled="!modelLoaded || !speakerName.trim()"
                        @click="startEnrollment()"><i class="ti ti-user-plus"></i> Enroll</button>
                <button class="btn secondary small" @click="skip()"><i class="ti ti-x"></i> Skip</button>
              </div>
            </div>

            <!-- Complete state (after enrollment) -->
            <div x-show="state === 'complete'">
              <div class="enrolled-header">
                <span class="enrolled-count" x-text="enrolledCountText">0 speakers enrolled</span>
                <div class="enrolled-actions">
                  <button class="btn danger-text small" @click="clearAll()" title="Remove all enrolled speakers"><i class="ti ti-trash"></i> Clear All</button>
                  <button id="add-speaker-btn" class="btn primary small"
                          :disabled="!modelLoaded || enrollments.length >= 6"
                          @click="addNewSpeaker()"><i class="ti ti-plus"></i> Add</button>
                </div>
              </div>
              <div id="enrolled-items">
                <template x-for="enrollment in enrollments" :key="enrollment.id">
                  <div class="enrolled-item" :data-id="enrollment.id">
                    <span class="speaker-dot" :style="`background: var(--speaker-${enrollment.colorIndex})`"></span>
                    <span class="enrolled-name" x-text="enrollment.name"></span>
                    <button class="btn-icon remove-enrollment"
                            @click="removeEnrollment(enrollment.id)" title="Remove"><i class="ti ti-x"></i></button>
                  </div>
                </template>
              </div>
            </div>

            <div id="enroll-status" :class="{ 'error': statusError }" x-text="statusMessage"></div>

            <!-- Speaker Embedding Visualization -->
            <div class="enrollment-viz-section">
              <div class="viz-divider"></div>
              <div class="viz-header">Speaker Embedding Space</div>
              <div class="viz-info">Dots closer together = more similar voices</div>
              <canvas id="speaker-canvas"></canvas>
            </div>
          </div>
        </section>

        <!-- Recordings Panel -->
        <div class="sidebar-panel" id="panel-recordings" x-data="recordingsPanel" x-cloak>
          <div class="panel-header" @click="toggle()">
            <i class="ti ti-chevron-down panel-chevron" :class="{ 'rotated': !expanded }"></i>
            <h3>Recordings <span x-show="recordings.length > 0" class="recording-count" x-text="'(' + recordings.length + ')'"></span></h3>
          </div>
          <div class="panel-content" :class="{ 'collapsed': !expanded }">
            <!-- Current session indicator -->
            <div class="recording-session-indicator" :class="{ 'viewing': isViewingRecording }">
              <template x-if="!isViewingRecording">
                <span class="session-live">Live Session</span>
              </template>
              <template x-if="isViewingRecording">
                <div class="session-viewing">
                  <span class="viewing-label">Viewing:</span>
                  <span class="viewing-name" x-text="viewedRecording?.name"></span>
                  <button class="btn-icon return-btn" @click="returnToLive()" title="Return to live"><i class="ti ti-arrow-back"></i></button>
                </div>
              </template>
            </div>

            <!-- Recordings list -->
            <div class="recordings-list" x-show="recordings.length > 0">
              <template x-for="recording in recordings" :key="recording.id">
                <div class="recording-item"
                     :class="{ 'selected': selectedId === recording.id }"
                     @click="loadRecording(recording.id)">
                  <!-- Name (editable) -->
                  <div class="recording-name-row">
                    <template x-if="isRenaming !== recording.id">
                      <span class="recording-name" x-text="recording.name"></span>
                    </template>
                    <template x-if="isRenaming === recording.id">
                      <input type="text"
                             class="rename-input"
                             x-model="renameValue"
                             @click.stop
                             @keydown.enter="confirmRename()"
                             @keydown.escape="cancelRename()"
                             @blur="confirmRename()">
                    </template>
                    <div class="recording-actions" @click.stop>
                      <button class="btn-icon" @click="startRename(recording.id, recording.name)" title="Rename"><i class="ti ti-pencil"></i></button>
                      <button class="btn-icon delete" @click="deleteRecording(recording.id)" title="Delete"><i class="ti ti-trash"></i></button>
                    </div>
                  </div>
                  <!-- Metadata -->
                  <div class="recording-meta">
                    <span class="meta-item" x-text="formatDuration(recording.duration)"></span>
                    <span class="meta-sep">|</span>
                    <span class="meta-item" x-text="recording.speakerCount + ' speaker' + (recording.speakerCount !== 1 ? 's' : '')"></span>
                    <span class="meta-sep">|</span>
                    <span class="meta-item" x-text="formatSize(recording.sizeBytes)"></span>
                  </div>
                  <div class="recording-date" x-text="formatDate(recording.createdAt)"></div>
                </div>
              </template>
            </div>

            <!-- Empty state -->
            <div class="recordings-empty" x-show="recordings.length === 0">
              <p>No saved recordings yet.</p>
              <p class="hint">Recordings are saved automatically when you stop recording.</p>
            </div>

            <!-- Playback controls (when viewing) -->
            <div class="playback-controls" x-show="isViewingRecording" x-cloak>
              <div class="playback-row">
                <button class="btn-icon play-btn" @click="togglePlay()">
                  <i x-show="!isPlaying" class="ti ti-player-play"></i>
                  <i x-show="isPlaying" class="ti ti-player-pause"></i>
                </button>
                <div class="playback-progress">
                  <div class="progress-bar">
                    <div class="progress-fill" :style="'width: ' + (playbackDuration > 0 ? (playbackTime / playbackDuration * 100) : 0) + '%'"></div>
                  </div>
                </div>
                <span class="playback-time" x-text="formatDuration(playbackTime) + ' / ' + formatDuration(playbackDuration)"></span>
                <button class="btn-icon download-btn" @click="downloadRecording()" title="Download as WAV">
                  <i class="ti ti-download"></i>
                </button>
              </div>

              <!-- Enrollment source toggle -->
              <div class="enrollment-toggle">
                <span class="toggle-label">Enrollments:</span>
                <button class="toggle-btn"
                        :class="{ 'active': enrollmentSource === 'snapshot' }"
                        @click="setEnrollmentSource('snapshot')"
                        title="Use enrollments from when recording was made">Snapshot</button>
                <button class="toggle-btn"
                        :class="{ 'active': enrollmentSource === 'current' }"
                        @click="setEnrollmentSource('current')"
                        title="Re-identify speakers with current enrollments">Current</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Model Status Panel -->
        <div class="sidebar-panel" id="panel-model-status" x-data="modelStatusPanel" x-cloak>
          <div class="panel-header" @click="toggle()">
            <i class="ti ti-chevron-down panel-chevron" :class="{ 'rotated': !expanded }"></i>
            <h3>Model Status</h3>
            <span class="model-status-indicator" x-show="!expanded" x-cloak>
              <i x-show="status === 'idle'" class="ti ti-loader-2 status-idle"></i>
              <svg x-show="status === 'loading'" class="svg-icon status-loading" width="16" height="16"><use href="#icon-loader"/></svg>
              <i x-show="status === 'ready'" class="ti ti-circle-check status-ready"></i>
              <i x-show="status === 'error'" class="ti ti-circle-x status-error"></i>
            </span>
          </div>
          <div class="panel-content" :class="{ 'collapsed': !expanded }" id="model-status">
            <div id="loading-message">Models will auto-load...</div>
            <button id="load-models-btn" class="btn primary small hidden"><i class="ti ti-refresh"></i> Reload Models</button>
            <div id="progress-container"></div>
            <div id="device-info"></div>
          </div>
        </div>

        <!-- Debug Logging Panel -->
        <div class="sidebar-panel" id="panel-debug" x-data="panel('debug', false)" x-cloak>
          <div class="panel-header" @click="toggle()">
            <i class="ti ti-chevron-down panel-chevron" :class="{ 'rotated': !expanded }"></i>
            <h3>Debug Logging</h3>
          </div>
          <div class="panel-content" :class="{ 'collapsed': !expanded }">
            <div class="debug-toggles">
              <label class="toggle-row">
                <input type="checkbox" id="debug-enabled">
                <span>Enable debug logging</span>
              </label>
              <label class="toggle-row" id="verbose-row">
                <input type="checkbox" id="debug-verbose" disabled>
                <span>Verbose mode</span>
              </label>
            </div>
            <div class="debug-actions">
              <button id="debug-export" class="btn secondary small" disabled><i class="ti ti-download"></i> Export</button>
              <button id="debug-clear" class="btn secondary small" disabled><i class="ti ti-trash"></i> Clear</button>
            </div>
            <div id="debug-status" class="debug-status">Logging disabled</div>
          </div>
        </div>

        <!-- Boosting Tuning Panel -->
        <div class="sidebar-panel" id="panel-boosting-tuning" x-data="boostingTuningPanel" x-cloak>
          <div class="panel-header" @click="toggle()">
            <i class="ti ti-chevron-down panel-chevron" :class="{ 'rotated': !expanded }"></i>
            <h3>Boosting Tuning</h3>
          </div>
          <div class="panel-content" :class="{ 'collapsed': !expanded }">
            <p class="tuning-intro">Adjust parameters to experiment with speaker boosting behavior.</p>

            <div class="tuning-controls">
              <!-- Boost Factor -->
              <div class="tuning-row">
                <label title="Multiplier applied to similarity scores for hypothesized participants">Boost Factor</label>
                <input type="range" min="1.0" max="1.30" step="0.01"
                       :value="boostFactor"
                       @input="updateParam('boostFactor', $event.target.value)">
                <span class="tuning-value" x-text="formatValue(boostFactor)"></span>
              </div>

              <!-- Eligibility Rank -->
              <div class="tuning-row">
                <label title="Speaker must be in top N matches to receive boost">Eligibility Rank</label>
                <input type="range" min="1" max="4" step="1"
                       :value="boostEligibilityRank"
                       @input="updateParam('boostEligibilityRank', $event.target.value)">
                <span class="tuning-value" x-text="boostEligibilityRank"></span>
              </div>

              <div class="tuning-section-header">Ambiguity Gating</div>

              <!-- Ambiguity Margin Threshold -->
              <div class="tuning-row">
                <label title="Only boost when margin between top candidates is below this">Max Margin</label>
                <input type="range" min="0.05" max="0.40" step="0.01"
                       :value="ambiguityMarginThreshold"
                       @input="updateParam('ambiguityMarginThreshold', $event.target.value)">
                <span class="tuning-value" x-text="formatValue(ambiguityMarginThreshold)"></span>
              </div>

              <!-- Skip Boost If Confident -->
              <div class="tuning-row">
                <label title="Skip boosting if best match similarity is above this">Skip if Confident</label>
                <input type="range" min="0.70" max="0.95" step="0.01"
                       :value="skipBoostIfConfident"
                       @input="updateParam('skipBoostIfConfident', $event.target.value)">
                <span class="tuning-value" x-text="formatValue(skipBoostIfConfident)"></span>
              </div>

              <!-- Min Similarity For Boosting -->
              <div class="tuning-row">
                <label title="Don't boost if best match is below this (garbage match)">Min Similarity</label>
                <input type="range" min="0.40" max="0.75" step="0.01"
                       :value="minSimilarityForBoosting"
                       @input="updateParam('minSimilarityForBoosting', $event.target.value)">
                <span class="tuning-value" x-text="formatValue(minSimilarityForBoosting)"></span>
              </div>

              <div class="tuning-section-header">Thresholds</div>

              <!-- Min Similarity After Boost -->
              <div class="tuning-row">
                <label title="Even with boost, must meet this threshold for assignment">Min After Boost</label>
                <input type="range" min="0.60" max="0.85" step="0.01"
                       :value="minSimilarityAfterBoost"
                       @input="updateParam('minSimilarityAfterBoost', $event.target.value)">
                <span class="tuning-value" x-text="formatValue(minSimilarityAfterBoost)"></span>
              </div>
            </div>

            <button class="btn secondary small tuning-reset" @click="resetDefaults()">
              <i class="ti ti-refresh"></i> Reset Defaults
            </button>
          </div>
        </div>

        <!-- Model Selection Panel -->
        <div class="sidebar-panel" id="panel-model-selection" x-data="modelSelection" x-cloak>
          <div class="panel-header" @click="toggle()">
            <i class="ti ti-chevron-down panel-chevron" :class="{ 'rotated': !expanded }"></i>
            <h3>Embedding Model</h3>
            <span class="panel-badge" x-text="currentModelInfo?.name || 'Loading...'"></span>
          </div>
          <div class="panel-content" :class="{ 'collapsed': !expanded }">
            <p class="model-intro">Select embedding model for speaker identification. Changing requires page reload.</p>

            <div class="model-select-wrapper">
              <select class="model-select"
                      :value="selectedModel"
                      @change="changeModel($event.target.value)"
                      :disabled="isLoading">
                <template x-for="model in models" :key="model.id">
                  <option :value="model.id" x-text="model.name" :selected="model.id === selectedModel"></option>
                </template>
              </select>
            </div>

            <template x-if="currentModelInfo">
              <div class="model-info">
                <div class="model-info-row">
                  <span class="model-info-label">Size:</span>
                  <span class="model-info-value" x-text="currentModelInfo.size"></span>
                </div>
                <div class="model-info-row">
                  <span class="model-info-label">Dimensions:</span>
                  <span class="model-info-value" x-text="currentModelInfo.dimensions"></span>
                </div>
                <div class="model-info-row">
                  <span class="model-info-label">Backend:</span>
                  <span class="model-info-value" x-text="currentModelInfo.backend"></span>
                </div>
                <p class="model-description" x-text="currentModelInfo.description"></p>
              </div>
            </template>

            <div class="model-warning" x-show="isLoading">
              <i class="ti ti-loader"></i> Reloading...
            </div>
          </div>
        </div>
      </aside>
    </main>

    <!-- Status Bar -->
    <footer id="status-bar" x-data="statusBar()" x-cloak>
      <div class="status-indicator">
        <span class="status-dot" :class="status"></span>
        <span x-text="statusText">Ready</span>
      </div>
      <div class="status-metrics">
        <div class="metric">
          <span class="metric-label">ASR:</span>
          <span class="metric-value" x-text="metrics.asr">-</span>
        </div>
        <div class="metric">
          <span class="metric-label">Embed:</span>
          <span class="metric-value" x-text="metrics.embed">-</span>
        </div>
        <div class="metric">
          <span class="metric-label">Total:</span>
          <span class="metric-value" x-text="metrics.total">-</span>
        </div>
      </div>
      <div class="status-chunks">
        <div class="chunk-slots">
          <template x-for="(active, index) in chunkSlots" :key="index">
            <div class="chunk-slot" :class="{ 'processing': index === 0 && active, 'queued': index > 0 && active }"></div>
          </template>
        </div>
        <span class="chunk-status" x-text="chunkStatus">Idle</span>
      </div>
      <div class="status-buffer">
        <span class="metric-label">Buffer:</span>
        <div class="buffer-bar">
          <div class="buffer-fill" :style="`width: ${bufferPercent}%`"></div>
        </div>
        <span class="metric-value" x-text="`${bufferPercent}%`">0%</span>
      </div>
    </footer>

    <!-- Enrollment Modal -->
    <div id="enrollment-modal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <div class="modal-content" role="document">
        <!-- Header -->
        <div class="modal-header">
          <h2 id="modal-title">Speaker Enrollment</h2>
          <span id="modal-speaker-name" class="modal-speaker-name"></span>
        </div>

        <!-- Passage -->
        <div class="modal-passage-section">
          <div class="passage-label">Read aloud:</div>
          <blockquote id="modal-passage-text" class="modal-passage-text"></blockquote>
        </div>

        <!-- Feedback (volume bar, VAD indicator, timer) -->
        <div class="modal-feedback-section">
          <div class="modal-volume-wrapper">
            <label class="feedback-label">Mic Level</label>
            <div class="modal-volume-bar">
              <div id="modal-volume-fill" class="volume-fill"></div>
            </div>
          </div>
          <div class="modal-vad-wrapper">
            <label class="feedback-label">Speech</label>
            <div id="modal-vad-indicator" class="vad-indicator listening">
              <span class="vad-dot"></span>
              <span id="modal-vad-text" class="vad-text">Listening...</span>
            </div>
          </div>
          <div class="modal-timer-wrapper">
            <label class="feedback-label">Duration</label>
            <span id="modal-recording-timer" class="recording-timer">0:00</span>
          </div>
        </div>

        <!-- Progress dots -->
        <div class="modal-progress-section">
          <span class="progress-label">Passages:</span>
          <div id="modal-progress-dots" class="modal-progress-dots"></div>
        </div>

        <!-- Status -->
        <div id="modal-status" class="modal-status"></div>

        <!-- Actions -->
        <div class="modal-actions">
          <div class="modal-record-group">
            <button id="modal-record-btn" class="btn primary"><i class="ti ti-microphone"></i> Record</button>
            <button id="modal-upload-btn" class="btn secondary"><i class="ti ti-upload"></i> Upload</button>
            <input type="file" id="modal-file-input" accept="audio/*" class="hidden">
          </div>
          <button id="modal-finish-btn" class="btn" disabled><i class="ti ti-check"></i> Finish</button>
          <button id="modal-cancel-btn" class="btn secondary"><i class="ti ti-x"></i> Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Feature 7: Comparison result overlay -->
  <div x-data="comparisonMode" x-show="result" x-cloak class="comparison-result" x-transition>
    <div class="comparison-result-header">
      <span class="comparison-result-title">Segment Comparison</span>
      <button class="comparison-result-close" @click="toggle()"><i class="ti ti-x"></i></button>
    </div>

    <template x-if="result && !result.error">
      <div>
        <div class="comparison-segments">
          <div class="comparison-segment">
            <span class="comparison-segment-label" x-text="result.segment1?.speaker || 'Segment 1'"></span>
            <span class="comparison-segment-text" x-text="(result.segment1?.text || '') + '...'"></span>
          </div>
          <div class="comparison-segment">
            <span class="comparison-segment-label" x-text="result.segment2?.speaker || 'Segment 2'"></span>
            <span class="comparison-segment-text" x-text="(result.segment2?.text || '') + '...'"></span>
          </div>
        </div>

        <div class="comparison-similarity">
          <span class="similarity-value" :class="similarityClass" x-text="similarityPercent + '%'"></span>
          <div class="similarity-bar-container">
            <div class="similarity-bar-fill" :class="similarityClass" :style="'width: ' + similarityPercent + '%'"></div>
          </div>
        </div>

        <div class="comparison-verdict" :class="verdictClass" x-text="verdictText"></div>
      </div>
    </template>

    <template x-if="result && result.error">
      <div class="comparison-verdict verdict-error" x-text="result.error"></div>
    </template>

    <div class="comparison-hint" x-show="enabled && !result">
      Click two segments to compare their voice embeddings
    </div>
  </div>

  <!-- Alpine.js components (must load before Alpine) -->
  <script src="/src/alpine/components.js"></script>
  <!-- Alpine.js with persist plugin for panel state persistence -->
  <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/persist@3/dist/cdn.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js"></script>

  <script type="module" src="/src/main.js"></script>
</body>
</html>
