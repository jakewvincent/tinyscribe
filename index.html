<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Transcription Studio</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/dist/tabler-icons.min.css">
  <link rel="stylesheet" href="/src/styles.css">
  <script>
    // Apply saved layout preferences before render to prevent flash
    (function() {
      var sidebarWidth = localStorage.getItem('sidebar-width');
      if (sidebarWidth) {
        document.documentElement.style.setProperty('--sidebar-width', sidebarWidth + 'px');
      }
      var workspaceTop = localStorage.getItem('workspace-top-percent');
      if (workspaceTop) {
        var style = document.createElement('style');
        style.textContent = '#raw-chunks-panel { flex: 0 0 ' + workspaceTop + '% !important; }';
        document.head.appendChild(style);
      }
    })();
  </script>
</head>
<body>
  <!-- SVG Sprite Sheet (hidden) -->
  <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
    <symbol id="icon-loader" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 3a9 9 0 1 0 9 9" />
    </symbol>
  </svg>

  <div id="app">
    <!-- Top Bar -->
    <header id="topbar">
      <div class="topbar-left">
        <h1>Transcription Studio</h1>
        <!-- Speakers Button -->
        <button x-data="speakersButton" class="btn secondary speakers-btn" @click="openModal()">
          <i class="ti ti-users"></i>
          <span x-text="buttonText">Speakers</span>
        </button>
      </div>
      <div class="topbar-center" x-data="recordingControls()" x-cloak>
        <div class="button-group">
          <button id="record-btn" class="btn"
                  :class="{ 'recording': isRecording }"
                  :disabled="!modelLoaded"
                  @click="toggleRecording()">
            <i x-show="!isRecording" class="ti ti-microphone"></i>
            <i x-show="isRecording" class="ti ti-player-stop"></i>
            <span x-text="isRecording ? 'Stop' : 'Record'"></span>
          </button>
          <button id="upload-btn" class="btn secondary"
                  :disabled="!modelLoaded || isRecording"
                  @click="uploadAudio()"><i class="ti ti-upload"></i> Upload</button>
          <input type="file" id="upload-file-input" accept="audio/*" class="hidden">
          <button id="clear-btn" class="btn secondary"
                  :disabled="!modelLoaded"
                  @click="clearTranscript()"><i class="ti ti-eraser"></i> Clear</button>
        </div>
        <div id="audio-visualizer" :class="{ 'active': isRecording }"></div>
        <div id="recording-status"></div>
      </div>
      <div class="topbar-right">
        <div class="mic-config">
          <label for="mic-select">Mic:</label>
          <select id="mic-select">
            <option value="">Default</option>
          </select>
        </div>
        <!-- Recordings Dropdown -->
        <div x-data="recordingsDropdown" class="recordings-dropdown-container">
          <button class="btn secondary recordings-dropdown-btn" @click="toggle()" :class="{ 'active': isOpen, 'viewing': isViewingRecording }">
            <i class="ti ti-folder"></i>
            <span x-text="buttonText">Recordings</span>
            <i class="ti ti-chevron-down recordings-chevron" :class="{ 'rotated': isOpen }"></i>
          </button>

          <!-- Dropdown Menu -->
          <div x-show="isOpen" x-transition @click.outside="close()" class="recordings-dropdown-menu">
            <!-- Current session indicator -->
            <div class="recordings-dropdown-header">
              <template x-if="!isViewingRecording">
                <span class="session-indicator live"><i class="ti ti-point-filled"></i> Live Session</span>
              </template>
              <template x-if="isViewingRecording">
                <div class="session-indicator viewing">
                  <span class="viewing-name" x-text="viewedRecording?.name"></span>
                  <button class="btn-icon-sm return-btn" @click="returnToLive()" title="Return to live">
                    <i class="ti ti-arrow-back"></i>
                  </button>
                </div>
              </template>
            </div>

            <!-- Recordings list -->
            <div class="recordings-dropdown-list" x-show="recordings.length > 0">
              <template x-for="recording in recordings" :key="recording.id">
                <div class="recordings-dropdown-item" :class="{ 'selected': selectedId === recording.id }" @click="loadRecording(recording.id)">
                  <div class="recording-item-main">
                    <span class="recording-item-name" x-text="recording.name"></span>
                    <span class="recording-item-duration" x-text="formatDuration(recording.duration)"></span>
                  </div>
                  <div class="recording-item-meta">
                    <span x-text="recording.speakerCount + ' speaker' + (recording.speakerCount !== 1 ? 's' : '')"></span>
                    <span class="meta-sep">|</span>
                    <span x-text="formatDate(recording.createdAt)"></span>
                  </div>
                  <div class="recording-item-actions" @click.stop>
                    <button class="btn-icon-sm" @click="deleteRecording(recording.id)" title="Delete">
                      <i class="ti ti-trash"></i>
                    </button>
                  </div>
                </div>
              </template>
            </div>

            <!-- Empty state -->
            <div class="recordings-dropdown-empty" x-show="recordings.length === 0">
              <p>No saved recordings yet.</p>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content Grid -->
    <main id="main-content">
      <!-- Transcript Workspace (left) -->
      <section id="transcript-section" class="workspace">
        <!-- Raw Chunks Panel (top 1/3) -->
        <div id="raw-chunks-panel">
          <div class="panel-header-inline">
            <h3>Raw ASR</h3>
            <span class="panel-subtitle">Word-by-word transcription before processing</span>
            <button id="export-raw-btn" class="btn secondary small" disabled><i class="ti ti-download"></i> Export</button>
          </div>
          <div id="raw-chunks-container">
            <p class="placeholder">Raw chunk data will appear here...</p>
          </div>
        </div>

        <!-- Divider -->
        <div class="workspace-divider"></div>

        <!-- Processed Transcript (bottom 2/3) -->
        <div id="processed-panel">
          <div class="panel-header-inline">
            <h3>Processed Transcript</h3>
            <span class="panel-subtitle">Grouped into phrases with speaker assignment</span>
            <!-- Feature 7: Comparison mode toggle -->
            <div x-data="comparisonMode" class="comparison-mode-controls">
              <button class="comparison-toggle" :class="{ 'active': enabled }" @click="toggle()" title="Compare segment embeddings">
                <i class="ti ti-arrows-left-right comparison-toggle-icon"></i>
                <span x-text="enabled ? 'Exit Compare' : 'Compare'"></span>
              </button>
            </div>
            <button id="export-all-jobs-btn" class="btn secondary small" disabled><i class="ti ti-package-export"></i> Export All</button>
          </div>

          <!-- Job Navigation Bar (visible when viewing a recording) -->
          <div x-data="jobNavigation" x-show="jobs.length > 0" x-cloak class="job-navigation-bar">
            <!-- Far left: Participants toggle -->
            <div class="job-nav-far-left">
              <button class="btn-icon-sm job-participants-toggle" :class="{ 'active': participantsSidebarOpen }" @click="toggleParticipants()" title="Toggle participants panel">
                <i class="ti ti-users"></i>
              </button>
            </div>

            <!-- Left: Navigation arrows and dropdown -->
            <div class="job-nav-left">
              <!-- Prev button -->
              <button class="btn-icon-sm job-nav-arrow" :disabled="!canGoPrev" @click="goPrev()" title="Previous job">
                <i class="ti ti-chevron-left"></i>
              </button>

              <!-- Job dropdown -->
              <div class="job-dropdown-container">
                <button class="job-dropdown-trigger" @click.stop="toggleDropdown()">
                  <span class="job-dropdown-label">
                    <span class="job-name" x-text="activeJob?.name || 'Select Job'"></span>
                    <span class="job-count" x-text="'(' + (currentIndex + 1) + '/' + jobCount + ')'"></span>
                  </span>
                  <i class="ti ti-chevron-down job-dropdown-chevron" :class="{ 'rotated': dropdownOpen }"></i>
                </button>

                <!-- Dropdown menu -->
                <div x-show="dropdownOpen" x-transition:enter="dropdown-enter" x-transition:leave="dropdown-leave" class="job-dropdown-menu">
                  <template x-for="job in jobs" :key="job.id">
                    <div class="job-dropdown-item" :class="{ 'active': job.id === activeJobId }" @click="switchToJob(job.id)">
                      <div class="job-item-main">
                        <span class="job-item-name" x-text="job.name"></span>
                        <span class="job-item-status" :class="getStatusClass(job.status)" x-text="formatStatus(job.status)"></span>
                        <span x-show="hasNotes(job)" class="job-item-notes-dot" title="Has notes"></span>
                      </div>
                      <div class="job-item-meta">
                        <span class="job-item-summary" x-text="getSettingsSummary(job)"></span>
                        <span class="job-item-date" x-text="formatDate(job.processedAt || job.createdAt)"></span>
                      </div>
                    </div>
                  </template>
                </div>
              </div>

              <!-- Next button -->
              <button class="btn-icon-sm job-nav-arrow" :disabled="!canGoNext" @click="goNext()" title="Next job">
                <i class="ti ti-chevron-right"></i>
              </button>
            </div>

            <!-- Center: Status badge (for unprocessed jobs) -->
            <div class="job-nav-center">
              <template x-if="isActiveJobUnprocessed">
                <div class="job-unprocessed-notice">
                  <span class="status-badge status-unprocessed">Unprocessed</span>
                  <button class="btn primary small" @click="processJob('quick')" :disabled="isProcessing">
                    <i class="ti ti-player-play"></i> Process
                  </button>
                </div>
              </template>
              <template x-if="isActiveJobProcessing">
                <div class="job-processing-notice">
                  <span class="status-badge status-processing">
                    <i class="ti ti-loader-2 spinning"></i>
                    Processing...
                  </span>
                  <span x-show="processingProgress.total > 0" class="processing-progress" x-text="processingProgress.current + '/' + processingProgress.total"></span>
                </div>
              </template>
            </div>

            <!-- Right: Actions -->
            <div class="job-nav-right">
              <!-- Copy JSON button -->
              <button class="btn secondary small" @click="copyJobJson()" :disabled="!activeJob || activeJob.status !== 'processed'" title="Copy job transcript as JSON">
                <i class="ti ti-clipboard"></i> Copy JSON
              </button>

              <!-- Export button -->
              <button class="btn secondary small" @click="exportJob()" :disabled="!activeJob || activeJob.status !== 'processed'" title="Export job transcript">
                <i class="ti ti-download"></i> Export
              </button>

              <!-- New Job button -->
              <button class="btn secondary small" @click="createNewJob()" :disabled="isProcessing" title="Create new job with current settings">
                <i class="ti ti-plus"></i> New Job
              </button>

              <!-- Clone button -->
              <button class="btn secondary small" @click="cloneJob()" :disabled="isProcessing" title="Clone this job's settings">
                <i class="ti ti-copy"></i> Clone
              </button>

              <!-- Edit popover -->
              <div class="job-edit-popover-container">
                <button class="btn-icon-sm" @click.stop="openEditPopover()" title="Edit job name and notes">
                  <i class="ti ti-pencil"></i>
                </button>

                <div x-show="editPopoverOpen" x-transition class="job-edit-popover">
                  <div class="popover-header">
                    <span class="popover-title">Edit Job</span>
                    <button class="btn-icon-sm popover-close" @click="closeEditPopover()"><i class="ti ti-x"></i></button>
                  </div>
                  <div class="popover-body">
                    <div class="form-group">
                      <label>Name</label>
                      <input type="text" x-model="editName" class="form-input" @keydown.enter="saveEdit()">
                    </div>
                    <div class="form-group">
                      <label>Notes</label>
                      <textarea x-model="editNotes" class="form-textarea" rows="3" placeholder="Add notes about this job..."></textarea>
                    </div>
                    <div class="form-group" x-show="activeJob?.settings">
                      <label>Settings Summary</label>
                      <div class="settings-summary-readonly" x-text="getSettingsSummary(activeJob)"></div>
                    </div>
                  </div>
                  <div class="popover-footer">
                    <button class="btn primary small" @click="saveEdit()">Done</button>
                  </div>
                </div>
              </div>

              <!-- Delete with confirmation -->
              <div class="job-delete-confirm-container">
                <button class="btn-icon-sm" :class="{ 'danger': deleteConfirmOpen }" :disabled="!canDelete" @click.stop="confirmDelete()" title="Delete job">
                  <i class="ti ti-trash"></i>
                </button>

                <div x-show="deleteConfirmOpen" x-transition class="job-delete-confirm">
                  <span class="confirm-text">Delete this job?</span>
                  <button class="btn danger small" @click="deleteJob()">Delete</button>
                  <button class="btn secondary small" @click="cancelDelete()">Cancel</button>
                </div>
              </div>

              <!-- Settings toggle -->
              <button class="btn-icon-sm job-settings-toggle" :class="{ 'active': settingsSidebarOpen }" @click="toggleSettings()" title="Toggle job settings">
                <i class="ti ti-settings"></i>
              </button>
            </div>
          </div>

          <!-- Playback Bar (visible when viewing a recording) -->
          <div x-data="playbackBar" x-show="isViewingRecording" x-cloak class="playback-bar">
            <button class="btn-icon playback-main-btn" @click="togglePlay()">
              <i x-show="!isPlaying" class="ti ti-player-play"></i>
              <i x-show="isPlaying" class="ti ti-player-pause"></i>
            </button>

            <div class="playback-progress-container" @click="seek($event)">
              <div class="playback-progress-bar">
                <div class="playback-progress-fill" :style="`width: ${progressPercent}%`"></div>
              </div>
            </div>

            <span class="playback-time" x-text="formatTime(playbackTime) + ' / ' + formatTime(playbackDuration)">0:00 / 0:00</span>

            <div class="playback-actions">
              <!-- Enrollment source toggle -->
              <div class="enrollment-source-toggle">
                <button class="toggle-option" :class="{ 'active': enrollmentSource === 'snapshot' }" @click="setEnrollmentSource('snapshot')" title="Use enrollments from when recording was made">
                  <i class="ti ti-camera"></i> Snapshot
                </button>
                <button class="toggle-option" :class="{ 'active': enrollmentSource === 'current' }" @click="setEnrollmentSource('current')" title="Re-identify with current enrollments">
                  <i class="ti ti-refresh"></i> Current
                </button>
              </div>

              <button class="btn-icon" @click="downloadRecording()" title="Download as WAV">
                <i class="ti ti-download"></i>
              </button>
            </div>
          </div>

          <!-- Transcript body with optional sidebars -->
          <div class="transcript-body" x-data="jobSettingsPanel">
            <!-- Participants Sidebar (left) -->
            <div class="job-participants-sidebar" x-show="$store.jobUI.participantsSidebarOpen" x-cloak x-transition>
              <div class="sidebar-header">
                <span class="sidebar-title">Participants</span>
              </div>
              <div class="sidebar-content">
                <div id="participants-list"></div>
                <div id="participants-status" class="participants-status">No participants yet</div>
              </div>
            </div>

            <div id="transcript-container">
              <p class="placeholder">Transcript will appear here when you start recording...</p>
            </div>

            <!-- Job Settings Sidebar -->
            <div class="job-settings-sidebar" x-show="isVisible && activeJob" x-cloak x-transition>
              <div class="settings-header">
                <span class="settings-title">Job Settings</span>
                <template x-if="isReadOnly">
                  <span class="readonly-badge">Read-only</span>
                </template>
                <template x-if="isLocked">
                  <span class="readonly-badge">Locked</span>
                </template>
              </div>

              <!-- Settings content (scrollable) -->
              <div class="settings-content">
                <!-- Read-only hint for processed jobs -->
                <template x-if="isReadOnly">
                  <p class="settings-hint">This job has been processed. To change settings, clone this job.</p>
                </template>

                <!-- Locked hint for processing jobs -->
                <template x-if="isLocked">
                  <p class="settings-hint">Processing in progress. Settings are locked.</p>
                </template>

                <!-- ===== MODELS SECTION ===== -->
                <div class="settings-group">
                  <div class="settings-group-header">Models</div>

                  <template x-if="isEditable">
                    <div class="settings-group-content">
                      <div class="settings-section">
                        <label class="settings-label">Embedding Model</label>
                        <select class="settings-select" x-model="settings.embeddingModelId" @change="updateSetting('embeddingModelId', $event.target.value)">
                          <template x-for="model in embeddingModels" :key="model.id">
                            <option :value="model.id" x-text="model.name"></option>
                          </template>
                        </select>
                      </div>

                      <div class="settings-section">
                        <label class="settings-label">Segmentation</label>
                        <select class="settings-select" x-model="settings.segmentationModelId" @change="onSegmentationModelChange($event.target.value)">
                          <template x-for="model in segmentationModels" :key="model.id">
                            <option :value="model.id" x-text="model.name"></option>
                          </template>
                        </select>
                      </div>
                    </div>
                  </template>

                  <template x-if="isReadOnly || isLocked">
                    <div class="settings-readonly">
                      <div class="settings-readonly-row">
                        <span class="settings-readonly-label">Embedding:</span>
                        <span class="settings-readonly-value" x-text="getEmbeddingModelName(settings.embeddingModelId)"></span>
                      </div>
                      <div class="settings-readonly-row">
                        <span class="settings-readonly-label">Segmentation:</span>
                        <span class="settings-readonly-value" x-text="getSegmentationModelName(settings.segmentationModelId)"></span>
                      </div>
                    </div>
                  </template>
                </div>

                <!-- ===== SEGMENTATION PARAMS SECTION ===== -->
                <template x-if="segmentationParamKeys.length > 0">
                  <div class="settings-group">
                    <div class="settings-group-header">Segmentation Params</div>

                    <template x-if="isEditable">
                      <div class="settings-group-content">
                        <template x-for="key in segmentationParamKeys" :key="key">
                          <div class="settings-section">
                            <label class="settings-label" :title="getSegParamDescription(key)" x-text="getSegParamLabel(key)"></label>
                            <div class="settings-row">
                              <input type="range" class="settings-slider"
                                     :min="getSegParamMin(key)"
                                     :max="getSegParamMax(key)"
                                     :step="getSegParamStep(key)"
                                     :value="settings.segmentationParams[key]"
                                     @input="updateSegmentationParam(key, parseFloat($event.target.value))">
                              <span class="settings-value" x-text="formatSegParamValue(key, settings.segmentationParams[key])"></span>
                            </div>
                          </div>
                        </template>
                      </div>
                    </template>

                    <template x-if="isReadOnly || isLocked">
                      <div class="settings-readonly">
                        <template x-for="key in segmentationParamKeys" :key="key">
                          <div class="settings-readonly-row">
                            <span class="settings-readonly-label" x-text="getSegParamLabel(key) + ':'"></span>
                            <span class="settings-readonly-value" x-text="formatSegParamValue(key, settings.segmentationParams[key])"></span>
                          </div>
                        </template>
                      </div>
                    </template>
                  </div>
                </template>

                <!-- ===== CLUSTERING SECTION ===== -->
                <div class="settings-group">
                  <div class="settings-group-header">Speaker Matching</div>

                  <template x-if="isEditable">
                    <div class="settings-group-content">
                      <div class="settings-section">
                        <label class="settings-label" title="Minimum cosine similarity to match a speaker">Similarity Threshold</label>
                        <div class="settings-row">
                          <input type="range" class="settings-slider" min="0.5" max="0.95" step="0.05" x-model="settings.similarityThreshold" @input="updateSetting('similarityThreshold', parseFloat($event.target.value))">
                          <span class="settings-value" x-text="formatThreshold(settings.similarityThreshold)"></span>
                        </div>
                      </div>

                      <div class="settings-section">
                        <label class="settings-label" title="Required margin between best and runner-up match">Confidence Margin</label>
                        <div class="settings-row">
                          <input type="range" class="settings-slider" min="0" max="0.3" step="0.01" x-model="settings.confidenceMargin" @input="updateSetting('confidenceMargin', parseFloat($event.target.value))">
                          <span class="settings-value" x-text="formatThreshold(settings.confidenceMargin)"></span>
                        </div>
                      </div>

                      <div class="settings-section">
                        <label class="settings-label" title="Maximum number of speakers to identify">Max Speakers</label>
                        <select class="settings-select" x-model="settings.numSpeakers" @change="updateSetting('numSpeakers', parseInt($event.target.value))">
                          <option value="1">1</option>
                          <option value="2">2</option>
                          <option value="3">3</option>
                          <option value="4">4</option>
                          <option value="5">5</option>
                          <option value="6">6</option>
                        </select>
                      </div>
                    </div>
                  </template>

                  <template x-if="isReadOnly || isLocked">
                    <div class="settings-readonly">
                      <div class="settings-readonly-row">
                        <span class="settings-readonly-label">Similarity:</span>
                        <span class="settings-readonly-value" x-text="formatThreshold(settings.similarityThreshold)"></span>
                      </div>
                      <div class="settings-readonly-row">
                        <span class="settings-readonly-label">Confidence:</span>
                        <span class="settings-readonly-value" x-text="formatThreshold(settings.confidenceMargin)"></span>
                      </div>
                      <div class="settings-readonly-row">
                        <span class="settings-readonly-label">Max Speakers:</span>
                        <span class="settings-readonly-value" x-text="settings.numSpeakers"></span>
                      </div>
                    </div>
                  </template>
                </div>

                <!-- ===== BOOSTING SECTION ===== -->
                <div class="settings-group">
                  <div class="settings-group-header">Conversation Boosting</div>

                  <template x-if="isEditable">
                    <div class="settings-group-content">
                      <div class="settings-section">
                        <label class="settings-label" title="Multiplier applied to similarity scores for hypothesized speakers">Boost Factor</label>
                        <div class="settings-row">
                          <input type="range" class="settings-slider" min="1.0" max="1.30" step="0.01" x-model="settings.boostFactor" @input="updateSetting('boostFactor', parseFloat($event.target.value))">
                          <span class="settings-value" x-text="formatThreshold(settings.boostFactor)"></span>
                        </div>
                      </div>

                      <div class="settings-section">
                        <label class="settings-label" title="Speaker must be in top N matches to receive boost">Eligibility Rank</label>
                        <div class="settings-row">
                          <input type="range" class="settings-slider" min="1" max="4" step="1" x-model="settings.boostEligibilityRank" @input="updateSetting('boostEligibilityRank', parseInt($event.target.value))">
                          <span class="settings-value" x-text="settings.boostEligibilityRank"></span>
                        </div>
                      </div>

                      <div class="settings-section">
                        <label class="settings-label" title="Only boost when margin between top candidates is below this">Max Margin</label>
                        <div class="settings-row">
                          <input type="range" class="settings-slider" min="0.05" max="0.40" step="0.01" x-model="settings.ambiguityMarginThreshold" @input="updateSetting('ambiguityMarginThreshold', parseFloat($event.target.value))">
                          <span class="settings-value" x-text="formatThreshold(settings.ambiguityMarginThreshold)"></span>
                        </div>
                      </div>

                      <div class="settings-section">
                        <label class="settings-label" title="Skip boosting if best match similarity is above this">Skip if Confident</label>
                        <div class="settings-row">
                          <input type="range" class="settings-slider" min="0.70" max="0.95" step="0.01" x-model="settings.skipBoostIfConfident" @input="updateSetting('skipBoostIfConfident', parseFloat($event.target.value))">
                          <span class="settings-value" x-text="formatThreshold(settings.skipBoostIfConfident)"></span>
                        </div>
                      </div>

                      <div class="settings-section">
                        <label class="settings-label" title="Don't boost if best match is below this (garbage match)">Min Similarity</label>
                        <div class="settings-row">
                          <input type="range" class="settings-slider" min="0.40" max="0.75" step="0.01" x-model="settings.minSimilarityForBoosting" @input="updateSetting('minSimilarityForBoosting', parseFloat($event.target.value))">
                          <span class="settings-value" x-text="formatThreshold(settings.minSimilarityForBoosting)"></span>
                        </div>
                      </div>

                      <div class="settings-section">
                        <label class="settings-label" title="Even with boost, must meet this threshold for assignment">Min After Boost</label>
                        <div class="settings-row">
                          <input type="range" class="settings-slider" min="0.60" max="0.85" step="0.01" x-model="settings.minSimilarityAfterBoost" @input="updateSetting('minSimilarityAfterBoost', parseFloat($event.target.value))">
                          <span class="settings-value" x-text="formatThreshold(settings.minSimilarityAfterBoost)"></span>
                        </div>
                      </div>
                    </div>
                  </template>

                  <template x-if="isReadOnly || isLocked">
                    <div class="settings-readonly">
                      <div class="settings-readonly-row">
                        <span class="settings-readonly-label">Boost Factor:</span>
                        <span class="settings-readonly-value" x-text="formatThreshold(settings.boostFactor)"></span>
                      </div>
                      <div class="settings-readonly-row">
                        <span class="settings-readonly-label">Eligibility Rank:</span>
                        <span class="settings-readonly-value" x-text="settings.boostEligibilityRank"></span>
                      </div>
                      <div class="settings-readonly-row">
                        <span class="settings-readonly-label">Max Margin:</span>
                        <span class="settings-readonly-value" x-text="formatThreshold(settings.ambiguityMarginThreshold)"></span>
                      </div>
                      <div class="settings-readonly-row">
                        <span class="settings-readonly-label">Skip if Confident:</span>
                        <span class="settings-readonly-value" x-text="formatThreshold(settings.skipBoostIfConfident)"></span>
                      </div>
                      <div class="settings-readonly-row">
                        <span class="settings-readonly-label">Min Similarity:</span>
                        <span class="settings-readonly-value" x-text="formatThreshold(settings.minSimilarityForBoosting)"></span>
                      </div>
                      <div class="settings-readonly-row">
                        <span class="settings-readonly-label">Min After Boost:</span>
                        <span class="settings-readonly-value" x-text="formatThreshold(settings.minSimilarityAfterBoost)"></span>
                      </div>
                    </div>
                  </template>
                </div>
              </div>

              <!-- Process button (for unprocessed jobs) -->
              <template x-if="isEditable">
                <div class="settings-footer">
                  <button class="btn primary" @click="processJob('quick')">
                    <i class="ti ti-player-play"></i> Process
                  </button>
                </div>
              </template>
            </div>
          </div>
        </div>
      </section>

    </main>

    <!-- Status Bar -->
    <footer id="status-bar" x-data="statusBar()" x-cloak>
      <!-- Model Status with Popover -->
      <div class="model-status-compact" @click="toggleModelPopover()">
        <i x-show="modelStatus === 'idle'" class="ti ti-cpu status-idle" title="Models idle"></i>
        <i x-show="modelStatus === 'loading'" class="ti ti-loader-2 spinning status-loading" title="Loading models..."></i>
        <i x-show="modelStatus === 'ready'" class="ti ti-circle-check status-ready" title="Models ready"></i>
        <i x-show="modelStatus === 'error'" class="ti ti-circle-x status-error" title="Model error"></i>

        <!-- Model Status Popover -->
        <div x-show="modelPopoverOpen" x-transition @click.outside="modelPopoverOpen = false" class="model-status-popover">
          <div class="popover-header">
            <span class="popover-title">Model Status</span>
            <button class="btn-icon-sm popover-close" @click.stop="modelPopoverOpen = false"><i class="ti ti-x"></i></button>
          </div>
          <div class="popover-body">
            <div id="loading-message">Models will auto-load...</div>
            <button id="load-models-btn" class="btn primary small hidden"><i class="ti ti-refresh"></i> Reload Models</button>
            <div id="progress-container"></div>
            <div id="device-info"></div>
          </div>
        </div>
      </div>

      <div class="status-indicator">
        <span class="status-dot" :class="status"></span>
        <span x-text="statusText">Ready</span>
      </div>
      <div class="status-metrics">
        <div class="metric">
          <span class="metric-label">ASR:</span>
          <span class="metric-value" x-text="metrics.asr">-</span>
        </div>
        <div class="metric">
          <span class="metric-label">Embed:</span>
          <span class="metric-value" x-text="metrics.embed">-</span>
        </div>
        <div class="metric">
          <span class="metric-label">Total:</span>
          <span class="metric-value" x-text="metrics.total">-</span>
        </div>
      </div>
      <div class="status-chunks">
        <div class="chunk-slots">
          <template x-for="(active, index) in chunkSlots" :key="index">
            <div class="chunk-slot" :class="{ 'processing': index === 0 && active, 'queued': index > 0 && active }"></div>
          </template>
        </div>
        <span class="chunk-status" x-text="chunkStatus">Idle</span>
      </div>
      <div class="status-buffer">
        <span class="metric-label">Buffer:</span>
        <div class="buffer-bar">
          <div class="buffer-fill" :style="`width: ${bufferPercent}%`"></div>
        </div>
        <span class="metric-value" x-text="`${bufferPercent}%`">0%</span>
      </div>

      <!-- Debug Status with Popover -->
      <div class="debug-status-compact" @click="toggleDebugPopover()">
        <i class="ti ti-bug" :class="{ 'debug-active': debugEnabled }" :title="debugEnabled ? 'Debug logging enabled' : 'Debug logging disabled'"></i>

        <!-- Debug Popover -->
        <div x-show="debugPopoverOpen" x-transition @click.outside="debugPopoverOpen = false" class="debug-status-popover">
          <div class="popover-header">
            <span class="popover-title">Debug Logging</span>
            <button class="btn-icon-sm popover-close" @click.stop="debugPopoverOpen = false"><i class="ti ti-x"></i></button>
          </div>
          <div class="popover-body">
            <div class="debug-toggles">
              <label class="toggle-row">
                <input type="checkbox" id="debug-enabled-popover" :checked="debugEnabled" @change="toggleDebug($event.target.checked)">
                <span>Enable debug logging</span>
              </label>
              <label class="toggle-row" :class="{ 'disabled': !debugEnabled }">
                <input type="checkbox" id="debug-verbose-popover" :checked="debugVerbose" :disabled="!debugEnabled" @change="toggleVerbose($event.target.checked)">
                <span>Verbose mode</span>
              </label>
            </div>
            <div class="debug-actions">
              <button class="btn secondary small" :disabled="!debugEnabled" @click="exportDebugLog()"><i class="ti ti-download"></i> Export</button>
              <button class="btn secondary small" :disabled="!debugEnabled" @click="clearDebugLog()"><i class="ti ti-trash"></i> Clear</button>
            </div>
            <div class="debug-status-text" x-text="debugStatusText">Logging disabled</div>
          </div>
        </div>
      </div>
    </footer>

    <!-- Enrollment Modal -->
    <div id="enrollment-modal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <div class="modal-content" role="document">
        <!-- Header -->
        <div class="modal-header">
          <h2 id="modal-title">Speaker Enrollment</h2>
          <span id="modal-speaker-name" class="modal-speaker-name"></span>
        </div>

        <!-- Passage -->
        <div class="modal-passage-section">
          <div class="passage-label">Read aloud:</div>
          <blockquote id="modal-passage-text" class="modal-passage-text"></blockquote>
        </div>

        <!-- Feedback (volume bar, VAD indicator, timer) -->
        <div class="modal-feedback-section">
          <div class="modal-volume-wrapper">
            <label class="feedback-label">Mic Level</label>
            <div class="modal-volume-bar">
              <div id="modal-volume-fill" class="volume-fill"></div>
            </div>
          </div>
          <div class="modal-vad-wrapper">
            <label class="feedback-label">Speech</label>
            <div id="modal-vad-indicator" class="vad-indicator listening">
              <span class="vad-dot"></span>
              <span id="modal-vad-text" class="vad-text">Listening...</span>
            </div>
          </div>
          <div class="modal-timer-wrapper">
            <label class="feedback-label">Duration</label>
            <span id="modal-recording-timer" class="recording-timer">0:00</span>
          </div>
        </div>

        <!-- Progress dots -->
        <div class="modal-progress-section">
          <span class="progress-label">Passages:</span>
          <div id="modal-progress-dots" class="modal-progress-dots"></div>
        </div>

        <!-- Status -->
        <div id="modal-status" class="modal-status"></div>

        <!-- Actions -->
        <div class="modal-actions">
          <div class="modal-record-group">
            <button id="modal-record-btn" class="btn primary"><i class="ti ti-microphone"></i> Record</button>
            <button id="modal-upload-btn" class="btn secondary"><i class="ti ti-upload"></i> Upload</button>
            <input type="file" id="modal-file-input" accept="audio/*" class="hidden">
          </div>
          <button id="modal-finish-btn" class="btn" disabled><i class="ti ti-check"></i> Finish</button>
          <button id="modal-cancel-btn" class="btn secondary"><i class="ti ti-x"></i> Cancel</button>
        </div>
      </div>
    </div>

    <!-- Speakers Management Modal -->
    <div x-data="speakersModal" x-show="isOpen" x-cloak class="modal-overlay speakers-modal-overlay" @keydown.escape.window="close()">
      <div class="modal-content speakers-modal" @click.outside="close()">
        <!-- Header -->
        <div class="modal-header">
          <h2>Speaker Enrollment</h2>
          <button class="btn-icon-sm modal-close" @click="close()"><i class="ti ti-x"></i></button>
        </div>

        <!-- Body -->
        <div class="modal-body">
          <!-- Enrollment Intro Section -->
          <div class="speakers-intro" x-show="enrollments.length === 0 && !isAdding">
            <p class="speakers-intro-text">Enroll speakers to improve identification accuracy. Record voice samples using the phonetically balanced Rainbow Passage.</p>
          </div>

          <!-- Enrolled Speakers List -->
          <div class="speakers-list" x-show="enrollments.length > 0">
            <template x-for="enrollment in enrollments" :key="enrollment.id">
              <div class="speaker-item">
                <span class="speaker-dot" :style="`background: var(--speaker-${enrollment.colorIndex})`"></span>
                <span class="speaker-name" x-text="enrollment.name"></span>
                <span class="speaker-samples" x-text="enrollment.sampleCount + ' sample' + (enrollment.sampleCount !== 1 ? 's' : '')"></span>
                <button class="btn-icon-sm remove-speaker" @click="removeEnrollment(enrollment.id)" title="Remove speaker">
                  <i class="ti ti-trash"></i>
                </button>
              </div>
            </template>
          </div>

          <!-- Add Speaker Form -->
          <div class="speaker-add-form" x-show="isAdding">
            <label for="new-speaker-name">Speaker Name</label>
            <input type="text" id="new-speaker-name" x-model="newSpeakerName" placeholder="e.g., Jake" maxlength="20" @keydown.enter="startEnrollment()" @keydown.escape="cancelAdd()">
          </div>

          <!-- Speaker Canvas Visualization -->
          <div class="speakers-viz" x-show="enrollments.length > 0">
            <div class="viz-header">
              <span class="viz-label">Embedding Space</span>
              <div class="viz-model-select" x-show="visualizationModels.length > 0">
                <select @change="changeVisualizationModel($event.target.value)" :value="selectedVisualizationModel" :disabled="visualizationLoading">
                  <template x-for="model in visualizationModels" :key="model.id">
                    <option :value="model.id" x-text="model.name + ' (' + model.dimensions + 'd)' + (model.hasEmbeddings ? '' : ' *')"></option>
                  </template>
                </select>
              </div>
            </div>
            <div class="viz-canvas-container">
              <canvas id="speakers-modal-canvas"></canvas>
              <div class="viz-loading-overlay" x-show="visualizationLoading">
                <div class="viz-spinner"></div>
                <span>Computing embeddings...</span>
              </div>
            </div>
            <!-- Discriminability Metrics -->
            <div class="viz-metrics" x-show="visualizationMetrics && enrollments.length >= 2">
              <div class="viz-metrics-row">
                <span class="metric-label" title="Average cosine similarity between all speaker pairs. Lower = better separation.">Mean Sim:</span>
                <span class="metric-value" x-text="visualizationMetrics?.meanSimilarity != null ? visualizationMetrics.meanSimilarity.toFixed(3) : '—'"></span>
              </div>
              <div class="viz-metrics-row">
                <span class="metric-label" title="Most similar (confusable) speaker pair. Lower = better separation.">Max Sim:</span>
                <span class="metric-value">
                  <span x-text="visualizationMetrics?.minSimilarity?.similarity != null ? visualizationMetrics.minSimilarity.similarity.toFixed(3) : '—'"></span>
                  <span class="metric-pair" x-show="visualizationMetrics?.minSimilarity?.pair" x-text="visualizationMetrics?.minSimilarity?.pair ? '(' + visualizationMetrics.minSimilarity.pair.join(' / ') + ')' : ''"></span>
                </span>
              </div>
              <div class="viz-metrics-row">
                <span class="metric-label" title="Silhouette score: how well-separated clusters are. Range [-1, 1], higher = better.">Silhouette:</span>
                <span class="metric-value" x-text="visualizationMetrics?.silhouetteScore != null ? visualizationMetrics.silhouetteScore.toFixed(3) : '—'"></span>
              </div>
            </div>
          </div>

          <!-- Status Message -->
          <div class="speakers-status" x-show="statusMessage" :class="{ 'error': statusError }" x-text="statusMessage"></div>
        </div>

        <!-- Footer Actions -->
        <div class="modal-footer">
          <template x-if="!isAdding">
            <div class="footer-actions">
              <button class="btn danger-text" x-show="enrollments.length > 0" @click="clearAll()">
                <i class="ti ti-trash"></i> Clear All
              </button>
              <div class="footer-right">
                <button class="btn primary" :disabled="!modelLoaded || enrollments.length >= 6" @click="startAdd()">
                  <i class="ti ti-plus"></i> Add Speaker
                </button>
              </div>
            </div>
          </template>
          <template x-if="isAdding">
            <div class="footer-actions">
              <button class="btn secondary" @click="cancelAdd()">Cancel</button>
              <button class="btn primary" :disabled="!newSpeakerName.trim()" @click="startEnrollment()">
                <i class="ti ti-microphone"></i> Start Recording
              </button>
            </div>
          </template>
        </div>
      </div>
    </div>
  </div>

  <!-- Feature 7: Comparison result overlay -->
  <div x-data="comparisonMode" x-show="result" x-cloak class="comparison-result" x-transition>
    <div class="comparison-result-header">
      <span class="comparison-result-title">Segment Comparison</span>
      <button class="comparison-result-close" @click="toggle()"><i class="ti ti-x"></i></button>
    </div>

    <template x-if="result && !result.error">
      <div>
        <div class="comparison-segments">
          <div class="comparison-segment">
            <span class="comparison-segment-label" x-text="result.segment1?.speaker || 'Segment 1'"></span>
            <span class="comparison-segment-text" x-text="(result.segment1?.text || '') + '...'"></span>
          </div>
          <div class="comparison-segment">
            <span class="comparison-segment-label" x-text="result.segment2?.speaker || 'Segment 2'"></span>
            <span class="comparison-segment-text" x-text="(result.segment2?.text || '') + '...'"></span>
          </div>
        </div>

        <div class="comparison-similarity">
          <span class="similarity-value" :class="similarityClass" x-text="similarityPercent + '%'"></span>
          <div class="similarity-bar-container">
            <div class="similarity-bar-fill" :class="similarityClass" :style="'width: ' + similarityPercent + '%'"></div>
          </div>
        </div>

        <div class="comparison-verdict" :class="verdictClass" x-text="verdictText"></div>
      </div>
    </template>

    <template x-if="result && result.error">
      <div class="comparison-verdict verdict-error" x-text="result.error"></div>
    </template>

    <div class="comparison-hint" x-show="enabled && !result">
      Click two segments to compare their voice embeddings
    </div>
  </div>

  <!-- Alpine.js components (must load before Alpine) -->
  <script src="/src/alpine/components.js"></script>
  <!-- Alpine.js with persist plugin for panel state persistence -->
  <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/persist@3/dist/cdn.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js"></script>

  <script type="module" src="/src/main.js"></script>
</body>
</html>
